{% extends 'dashboard/dashboard.html' %} 
{% load static %} 
{% block dashboard_content %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<div class="container py-4">
  <h3 class="font-weight-bold mb-4">Tingkat Hunian Hotel</h3>
  
  <!-- Summary Cards -->
<div class="row mb-4">
  <!-- TPK Total Card -->
  <div class="col-6 col-md-3 mb-3">
    <div class="summary-card" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border-radius: 12px; padding: 16px; height: 100%; min-height: 140px; position: relative; overflow: hidden; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); display: flex; flex-direction: column;">
      <div style="position: relative; z-index: 2; flex: 1; display: flex; flex-direction: column;">
        <h6 style="color: rgba(255, 255, 255, 0.9); font-size: 11px; font-weight: 600; margin: 0 0 8px 0; text-transform: uppercase; letter-spacing: 0.5px;">TPK Total</h6>
        <h2 style="font-size: 28px; font-weight: 700; line-height: 1.2; margin: 0 0 auto 0;">
          {% if latest_month_data and latest_month_data.tpk %}
            {{ latest_month_data.tpk|floatformat:2 }}%
          {% else %}
            -
          {% endif %}
        </h2>
        <small style="color: rgba(255, 255, 255, 0.8); font-size: 10px; margin-top: 8px;">
          {% if latest_month_data %}
            {% if latest_month_data.month == "Januari" %}Jan
            {% elif latest_month_data.month == "Februari" %}Feb
            {% elif latest_month_data.month == "Maret" %}Mar
            {% elif latest_month_data.month == "April" %}Apr
            {% elif latest_month_data.month == "Mei" %}Mei
            {% elif latest_month_data.month == "Juni" %}Jun
            {% elif latest_month_data.month == "Juli" %}Jul
            {% elif latest_month_data.month == "Agustus" %}Ags
            {% elif latest_month_data.month == "September" %}Sep
            {% elif latest_month_data.month == "Oktober" %}Okt
            {% elif latest_month_data.month == "November" %}Nov
            {% elif latest_month_data.month == "Desember" %}Des
            {% else %}{{ latest_month_data.month|slice:":3" }}{% endif %} {{ latest_month_data.year }}
          {% endif %}
        </small>
      </div>
      <div style="position: absolute; top: 12px; right: 12px; opacity: 0.15; z-index: 1;">
        <i class="fas fa-bed" style="font-size: 48px;"></i>
      </div>
    </div>
  </div>

  <!-- MKTJ Card -->
  <div class="col-6 col-md-3 mb-3">
    <div class="summary-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border-radius: 12px; padding: 16px; height: 100%; min-height: 140px; position: relative; overflow: hidden; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); display: flex; flex-direction: column;">
      <div style="position: relative; z-index: 2; flex: 1; display: flex; flex-direction: column;">
        <h6 style="color: rgba(255, 255, 255, 0.9); font-size: 11px; font-weight: 600; margin: 0 0 8px 0; text-transform: uppercase; letter-spacing: 0.5px;">MKTJ</h6>
        <h2 style="font-size: 28px; font-weight: 700; line-height: 1.2; margin: 0 0 auto 0;">
          {% if latest_month_data and latest_month_data.mktj %}
            {{ latest_month_data.mktj|floatformat:0 }}
          {% else %}
            -
          {% endif %}
        </h2>
        <small style="color: rgba(255, 255, 255, 0.8); font-size: 10px; margin-top: 8px;">
          {% if latest_month_data %}
            {% if latest_month_data.month == "Januari" %}Jan
            {% elif latest_month_data.month == "Februari" %}Feb
            {% elif latest_month_data.month == "Maret" %}Mar
            {% elif latest_month_data.month == "April" %}Apr
            {% elif latest_month_data.month == "Mei" %}Mei
            {% elif latest_month_data.month == "Juni" %}Jun
            {% elif latest_month_data.month == "Juli" %}Jul
            {% elif latest_month_data.month == "Agustus" %}Ags
            {% elif latest_month_data.month == "September" %}Sep
            {% elif latest_month_data.month == "Oktober" %}Okt
            {% elif latest_month_data.month == "November" %}Nov
            {% elif latest_month_data.month == "Desember" %}Des
            {% else %}{{ latest_month_data.month|slice:":3" }}{% endif %} {{ latest_month_data.year }}
          {% endif %}
        </small>
      </div>
      <div style="position: absolute; top: 12px; right: 12px; opacity: 0.15; z-index: 1;">
        <i class="fas fa-users" style="font-size: 48px;"></i>
      </div>
    </div>
  </div>

  <!-- RLMT Gabungan Card -->
  <div class="col-6 col-md-3 mb-3">
    <div class="summary-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border-radius: 12px; padding: 16px; height: 100%; min-height: 140px; position: relative; overflow: hidden; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); display: flex; flex-direction: column;">
      <div style="position: relative; z-index: 2; flex: 1; display: flex; flex-direction: column;">
        <h6 style="color: rgba(255, 255, 255, 0.9); font-size: 11px; font-weight: 600; margin: 0 0 8px 0; text-transform: uppercase; letter-spacing: 0.5px;">RLMT Gabungan</h6>
        <div style="margin: 0 0 auto 0;">
          {% if latest_month_data and latest_month_data.rlmtgab %}
            <h2 style="font-size: 28px; font-weight: 700; line-height: 1.2; margin: 0;">{{ latest_month_data.rlmtgab|floatformat:2 }}</h2>
            <div style="font-size: 13px; font-weight: 500; margin-top: 2px; line-height: 1.2; color: rgba(255, 255, 255, 0.9);">malam</div>
          {% else %}
            <h2 style="font-size: 28px; font-weight: 700; line-height: 1.2; margin: 0;">-</h2>
          {% endif %}
        </div>
        <small style="color: rgba(255, 255, 255, 0.8); font-size: 10px; margin-top: 8px;">
          {% if latest_month_data %}
            {% if latest_month_data.month == "Januari" %}Jan
            {% elif latest_month_data.month == "Februari" %}Feb
            {% elif latest_month_data.month == "Maret" %}Mar
            {% elif latest_month_data.month == "April" %}Apr
            {% elif latest_month_data.month == "Mei" %}Mei
            {% elif latest_month_data.month == "Juni" %}Jun
            {% elif latest_month_data.month == "Juli" %}Jul
            {% elif latest_month_data.month == "Agustus" %}Ags
            {% elif latest_month_data.month == "September" %}Sep
            {% elif latest_month_data.month == "Oktober" %}Okt
            {% elif latest_month_data.month == "November" %}Nov
            {% elif latest_month_data.month == "Desember" %}Des
            {% else %}{{ latest_month_data.month|slice:":3" }}{% endif %} {{ latest_month_data.year }}
          {% endif %}
        </small>
      </div>
      <div style="position: absolute; top: 12px; right: 12px; opacity: 0.15; z-index: 1;">
        <i class="fas fa-moon" style="font-size: 48px;"></i>
      </div>
    </div>
  </div>

  <!-- GPR Card -->
  <div class="col-6 col-md-3 mb-3">
    <div class="summary-card" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);; color: white; border-radius: 12px; padding: 16px; height: 100%; min-height: 140px; position: relative; overflow: hidden; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); display: flex; flex-direction: column;">
      <div style="position: relative; z-index: 2; flex: 1; display: flex; flex-direction: column;">
        <h6 style="color: rgba(255, 255, 255, 0.9); font-size: 11px; font-weight: 600; margin: 0 0 8px 0; text-transform: uppercase; letter-spacing: 0.5px;">GPR</h6>
        <h2 style="font-size: 28px; font-weight: 700; line-height: 1.2; margin: 0 0 auto 0;">
          {% if latest_month_data and latest_month_data.gpr %}
            {{ latest_month_data.gpr|floatformat:2 }}
          {% else %}
            -
          {% endif %}
        </h2>
        <small style="color: rgba(255, 255, 255, 0.8); font-size: 10px; margin-top: 8px;">
          {% if latest_month_data %}
            {% if latest_month_data.month == "Januari" %}Jan
            {% elif latest_month_data.month == "Februari" %}Feb
            {% elif latest_month_data.month == "Maret" %}Mar
            {% elif latest_month_data.month == "April" %}Apr
            {% elif latest_month_data.month == "Mei" %}Mei
            {% elif latest_month_data.month == "Juni" %}Jun
            {% elif latest_month_data.month == "Juli" %}Jul
            {% elif latest_month_data.month == "Agustus" %}Ags
            {% elif latest_month_data.month == "September" %}Sep
            {% elif latest_month_data.month == "Oktober" %}Okt
            {% elif latest_month_data.month == "November" %}Nov
            {% elif latest_month_data.month == "Desember" %}Des
            {% else %}{{ latest_month_data.month|slice:":3" }}{% endif %} {{ latest_month_data.year }}
          {% endif %}
        </small>
      </div>
      <div style="position: absolute; top: 12px; right: 12px; opacity: 0.15; z-index: 1;">
        <i class="fas fa-chart-line" style="font-size: 48px;"></i>
      </div>
    </div>
  </div>
</div>

  <!-- Year Selector and Chart -->
  <div class="row">
    <div class="col-md-12">
      <div class="dashboard-card" style="position: relative;">
        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
          <h4 class="mb-2 mb-md-0" style="font-size: clamp(18px, 3vw, 24px);">Perkembangan Tingkat Penghunian Kamar (TPK)</h4>
          <div style="display: flex; gap: 8px; align-items: center;">
            <div class="dropdown">
              <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" id="yearDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                Tahun: <span id="selectedYear">{{ latest_year|default:"-" }}</span>
              </button>
              <ul class="dropdown-menu" aria-labelledby="yearDropdown" id="yearDropdownMenu">
                {% for year in distinct_years %}
                  <li><a class="dropdown-item year-option" href="#" data-year="{{ year }}">{{ year }}</a></li>
                {% endfor %}
              </ul>
            </div>
            <button id="downloadTpkLineExcel" class="btn btn-sm btn-outline-primary" style="padding: 5px 10px; border-radius: 5px;" title="Download Data Excel">
              <i class="fas fa-file-excel"></i> <span>Excel</span>
            </button>
            <button id="downloadTpkLinePNG" class="btn btn-sm btn-outline-success" style="padding: 5px 10px; border-radius: 5px;" title="Download Grafik PNG">
              <i class="fas fa-image"></i> <span>PNG</span>
            </button>
          </div>
        </div>
        <div class="chart-container-wrapper">
          <div id="tpkLineChart" class="chart-container"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Multi-Year Comparison Chart -->
  <div class="row mt-4">
    <div class="col-md-12">
      <div class="dashboard-card" style="position: relative;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
          <h4 class="mb-0" style="font-size: clamp(18px, 3vw, 24px);">Perbandingan TPK Beberapa Tahun</h4>
          <div style="display: flex; gap: 8px;">
            <button id="downloadTpkComparisonExcel" class="btn btn-sm btn-outline-primary" style="padding: 5px 10px; border-radius: 5px;" title="Download Data Excel">
              <i class="fas fa-file-excel"></i> <span>Excel</span>
            </button>
            <button id="downloadTpkComparisonPNG" class="btn btn-sm btn-outline-success" style="padding: 5px 10px; border-radius: 5px;" title="Download Grafik PNG">
              <i class="fas fa-image"></i> <span>PNG</span>
            </button>
          </div>
        </div>
        <div class="chart-container-wrapper">
          <div id="tpkComparisonChart" class="chart-container"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .dashboard-card {
    background-color: white;
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    padding: 20px;
    margin-bottom: 20px;
  }
  
  .summary-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }
  
  .summary-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
  }

  /* Chart container styles */
  .chart-container-wrapper {
    position: relative;
    width: 100%;
    overflow-x: auto;
    overflow-y: hidden;
    -webkit-overflow-scrolling: touch;
    margin-bottom: 10px;
  }

  .chart-container {
    position: relative;
    min-height: 350px;
    height: 400px;
  }

  /* Desktop: normal size */
  @media (min-width: 768px) {
    .chart-container {
      width: 100%;
      height: 450px;
    }
    
    .chart-container-wrapper {
      overflow-x: hidden;
    }
  }

  /* Mobile: wider container for scrolling */
  @media (max-width: 767px) {
    .chart-container {
      width: 150%;
      min-width: 150%;
      height: 350px;
    }

    .chart-container-wrapper {
      border-radius: 8px;
    }

    .chart-container-wrapper::-webkit-scrollbar {
      height: 6px;
    }

    .chart-container-wrapper::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }

    .chart-container-wrapper::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 10px;
    }

    .chart-container-wrapper::-webkit-scrollbar-thumb:hover {
      background: #555;
    }

    /* Adjust grid padding for mobile */
    .dashboard-card {
      padding: 15px;
    }
    
    /* Download button responsive */
    .dashboard-card button[id*="download"] {
      padding: 3px 8px !important;
      font-size: 11px !important;
    }
    
    .dashboard-card button[id*="download"] i {
      font-size: 10px !important;
    }
    
    .dashboard-card button[id*="download"] span {
      display: none;
    }
  }
  
  /* Download button styles */
  .dashboard-card button[id*="download"] {
    white-space: nowrap;
  }
  
  @media (max-width: 576px) {
    .dashboard-card button[id*="download"] {
      padding: 4px 6px !important;
      font-size: 10px !important;
    }
    
    .dashboard-card button[id*="download"] i {
      font-size: 12px !important;
      margin: 0 !important;
    }
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    // Prepare data from Django template
    const rawOccupancyData = [
      {% for data in occupancy_data %}
      {
        year: {{ data.year }},
        month: "{{ data.month|escapejs }}",
        tpk: {{ data.tpk|default:"null" }},
        mktj: {{ data.mktj|default:"null" }},
        rlmtgab: {{ data.rlmtgab|default:"null" }},
        gpr: {{ data.gpr|default:"null" }}
      }{% if not forloop.last %},{% endif %}
      {% endfor %}
    ];
    
    console.log('Raw occupancy data:', rawOccupancyData);

    // Month order for sorting (chronological order) - using full names
    const monthOrder = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                        'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
    
    // Mapping from database month names to standard month names
    const monthNameMap = {
      'Januari': 'Januari', 'Februari': 'Februari', 'Maret': 'Maret', 
      'April': 'April', 'Mei': 'Mei', 'Juni': 'Juni',
      'Juli': 'Juli', 'Agustus': 'Agustus', 'September': 'September',
      'Oktober': 'Oktober', 'November': 'November', 'Desember': 'Desember',
      'Jan': 'Januari', 'Feb': 'Februari', 'Mar': 'Maret',
      'Apr': 'April', 'Jun': 'Juni', 'Jul': 'Juli',
      'Ags': 'Agustus', 'Agst': 'Agustus', 'Sep': 'September',
      'Sept': 'September', 'Okt': 'Oktober', 'Nov': 'November', 'Des': 'Desember'
    };
    
    // Month abbreviations for display
    const monthAbbr = {
      'Januari': 'Jan', 'Februari': 'Feb', 'Maret': 'Mar', 'April': 'Apr',
      'Mei': 'Mei', 'Juni': 'Jun', 'Juli': 'Jul', 'Agustus': 'Ags',
      'September': 'Sep', 'Oktober': 'Okt', 'November': 'Nov', 'Desember': 'Des'
    };
    
    // Helper function to normalize month name
    function normalizeMonth(monthName) {
      if (!monthName) return null;
      const trimmed = monthName.trim();
      if (monthNameMap[trimmed]) {
        return monthNameMap[trimmed];
      }
      const lower = trimmed.toLowerCase();
      for (const [key, value] of Object.entries(monthNameMap)) {
        if (key.toLowerCase() === lower) {
          return value;
        }
      }
      console.warn('Unknown month name:', monthName);
      return trimmed;
    }

    // Normalize month names in raw data
    rawOccupancyData.forEach(d => {
      d.normalizedMonth = normalizeMonth(d.month);
    });
    
    // Sort all data by year and month (chronological order)
    const occupancyData = rawOccupancyData.sort((a, b) => {
      if (a.year !== b.year) {
        return a.year - b.year;
      }
      const monthA = a.normalizedMonth || a.month;
      const monthB = b.normalizedMonth || b.month;
      const indexA = monthOrder.indexOf(monthA);
      const indexB = monthOrder.indexOf(monthB);
      if (indexA === -1 && indexB === -1) return 0;
      if (indexA === -1) return 1;
      if (indexB === -1) return -1;
      return indexA - indexB;
    });

    // Get unique years
    const years = [...new Set(occupancyData.map(d => d.year))].sort();
    let selectedYear = {{ latest_year|default:"null" }} || years[years.length - 1];

    // Initialize ECharts instances
    const lineChart = echarts.init(document.getElementById('tpkLineChart'));
    const comparisonChart = echarts.init(document.getElementById('tpkComparisonChart'));

    // Filter data by selected year and sort by month order
    function getDataByYear(year) {
      const allYearData = occupancyData.filter(d => d.year === year);
      const yearData = allYearData.filter(d => d.tpk !== null && d.tpk !== undefined);
      
      const dataMap = {};
      yearData.forEach(d => {
        const normalizedMonth = d.normalizedMonth || normalizeMonth(d.month);
        if (normalizedMonth) {
          dataMap[normalizedMonth] = d;
        }
      });
      
      const sortedData = [];
      monthOrder.forEach(month => {
        if (dataMap[month]) {
          sortedData.push(dataMap[month]);
        }
      });
      
      console.log('Final sorted data for year', year, ':', sortedData.map(d => d.normalizedMonth || d.month));
      
      return sortedData;
    }

    // Create line chart for selected year using ECharts
    function createLineChart(year) {
      const sortedData = getDataByYear(year);
      
      const labels = [];
      const dataValues = [];
      
      sortedData.forEach(d => {
        const normalizedMonth = d.normalizedMonth || normalizeMonth(d.month);
        labels.push(monthAbbr[normalizedMonth] || normalizedMonth || d.month);
        dataValues.push(d.tpk ? d.tpk.toFixed(2) : null);
      });
      
      console.log('Final labels order:', labels);
      console.log('Data values:', dataValues);

      if (labels.length === 0 || dataValues.length === 0) {
        console.error('No data to display for year', year);
        return;
      }

      const option = {
        title: {
          show: false
        },
        tooltip: {
          trigger: 'axis',
          backgroundColor: 'rgba(0, 0, 0, 0.8)',
          borderColor: 'transparent',
          textStyle: {
            color: '#fff',
            fontSize: 13
          },
          formatter: function(params) {
            const param = params[0];
            return `Bulan: ${param.name}<br/>TPK: ${param.value}%`;
          }
        },
        legend: {
          data: [`TPK ${year}`],
          top: 10,
          textStyle: {
            fontSize: 14
          }
        },
        grid: {
          left: 60,
          right: 40,
          bottom: 60,
          top: 60,
          containLabel: true
        },
        xAxis: {
          type: 'category',
          boundaryGap: false,
          data: labels,
          name: 'Bulan',
          nameLocation: 'middle',
          nameGap: 30,
          nameTextStyle: {
            fontSize: 13,
            fontWeight: 'bold'
          },
          axisLabel: {
            fontSize: 12
          }
        },
        yAxis: {
          type: 'value',
          name: 'Tingkat Penghunian Kamar (%)',
          nameLocation: 'middle',
          nameGap: 50,
          nameTextStyle: {
            fontSize: 13,
            fontWeight: 'bold'
          },
          min: 30,
          max: 70,
          axisLabel: {
            formatter: '{value}%',
            fontSize: 12
          },
          splitLine: {
            lineStyle: {
              color: 'rgba(0, 0, 0, 0.05)'
            }
          }
        },
        series: [
          {
            name: `TPK ${year}`,
            type: 'line',
            data: dataValues,
            smooth: true,
            symbol: 'circle',
            symbolSize: 8,
            itemStyle: {
              color: 'rgb(220, 38, 38)',
              borderColor: '#fff',
              borderWidth: 2
            },
            lineStyle: {
              color: 'rgb(220, 38, 38)',
              width: 2
            },
            areaStyle: {
              color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                { offset: 0, color: 'rgba(220, 38, 38, 0.3)' },
                { offset: 1, color: 'rgba(220, 38, 38, 0.05)' }
              ])
            },
            emphasis: {
              focus: 'series',
              itemStyle: {
                shadowBlur: 10,
                shadowColor: 'rgba(220, 38, 38, 0.5)'
              }
            }
          }
        ]
      };

      lineChart.setOption(option);
    }

    // Create comparison chart for multiple years using ECharts
    function createComparisonChart() {
      const recentYears = years.slice(-3);
      
      const colorPalette = [
        'rgb(220, 38, 38)',   // Red
        'rgb(37, 99, 235)',   // Blue
        'rgb(234, 179, 8)',   // Yellow
        'rgb(34, 197, 94)',   // Green
        'rgb(168, 85, 247)',  // Purple
        'rgb(236, 72, 153)'   // Pink
      ];
      
      const allMonths = new Set();
      recentYears.forEach(year => {
        const yearData = getDataByYear(year);
        yearData.forEach(d => {
          const normalizedMonth = d.normalizedMonth || normalizeMonth(d.month);
          if (normalizedMonth) {
            allMonths.add(normalizedMonth);
          }
        });
      });
      
      const sortedMonths = [];
      monthOrder.forEach(month => {
        if (allMonths.has(month)) {
          sortedMonths.push(month);
        }
      });
      
      const labels = sortedMonths.map(month => monthAbbr[month] || month);
      
      const seriesData = recentYears.map((year, yearIndex) => {
        const yearData = getDataByYear(year);
        const color = colorPalette[yearIndex % colorPalette.length];
        
        const yearDataMap = {};
        yearData.forEach(d => {
          const normalizedMonth = d.normalizedMonth || normalizeMonth(d.month);
          if (normalizedMonth) {
            yearDataMap[normalizedMonth] = d.tpk;
          }
        });
        
        const alignedData = sortedMonths.map(month => {
          const val = yearDataMap[month];
          return val !== undefined ? val.toFixed(2) : null;
        });
        
        return {
          name: `${year}`,
          type: 'line',
          data: alignedData,
          smooth: true,
          symbol: 'circle',
          symbolSize: 8,
          itemStyle: {
            color: color,
            borderColor: '#fff',
            borderWidth: 2
          },
          lineStyle: {
            color: color,
            width: 2
          },
          connectNulls: true,
          emphasis: {
            focus: 'series',
            itemStyle: {
              shadowBlur: 10,
              shadowColor: color
            }
          }
        };
      });

      const option = {
        title: {
          show: false
        },
        tooltip: {
          trigger: 'axis',
          backgroundColor: 'rgba(0, 0, 0, 0.8)',
          borderColor: 'transparent',
          textStyle: {
            color: '#fff',
            fontSize: 13
          },
          formatter: function(params) {
            let result = `Bulan: ${params[0].name}<br/>`;
            params.forEach(param => {
              if (param.value !== null) {
                result += `${param.seriesName}: ${param.value}%<br/>`;
              }
            });
            return result;
          }
        },
        legend: {
          data: recentYears.map(y => `${y}`),
          top: 10,
          textStyle: {
            fontSize: 14
          }
        },
        grid: {
          left: 60,
          right: 40,
          bottom: 60,
          top: 60,
          containLabel: true
        },
        xAxis: {
          type: 'category',
          boundaryGap: false,
          data: labels,
          name: 'Bulan',
          nameLocation: 'middle',
          nameGap: 30,
          nameTextStyle: {
            fontSize: 13,
            fontWeight: 'bold'
          },
          axisLabel: {
            fontSize: 12,
            rotate: 0
          }
        },
        yAxis: {
          type: 'value',
          name: 'Tingkat Penghunian Kamar (%)',
          nameLocation: 'middle',
          nameGap: 50,
          nameTextStyle: {
            fontSize: 13,
            fontWeight: 'bold'
          },
          min: 30,
          max: 70,
          axisLabel: {
            formatter: '{value}%',
            fontSize: 12
          },
          splitLine: {
            lineStyle: {
              color: 'rgba(0, 0, 0, 0.05)'
            }
          }
        },
        series: seriesData
      };

      comparisonChart.setOption(option);
    }

    // Year dropdown handler
    document.querySelectorAll('.year-option').forEach(option => {
      option.addEventListener('click', function(e) {
        e.preventDefault();
        selectedYear = parseInt(this.getAttribute('data-year'));
        document.getElementById('selectedYear').textContent = selectedYear;
        createLineChart(selectedYear);
      });
    });

    // Initialize charts
    if (selectedYear) {
      createLineChart(selectedYear);
    }
    createComparisonChart();

    // Handle window resize for responsive charts
    window.addEventListener('resize', function() {
      lineChart.resize();
      comparisonChart.resize();
    });

    // Adjust grid for mobile
    function isMobile() {
      return window.innerWidth <= 767;
    }

    function adjustChartForMobile() {
      if (isMobile()) {
        // Update line chart grid for mobile
        const lineOption = lineChart.getOption();
        lineOption.grid[0].left = 50;
        lineOption.grid[0].right = 20;
        lineOption.grid[0].bottom = 50;
        lineChart.setOption(lineOption);

        // Update comparison chart grid for mobile
        const compOption = comparisonChart.getOption();
        compOption.grid[0].left = 50;
        compOption.grid[0].right = 20;
        compOption.grid[0].bottom = 50;
        comparisonChart.setOption(compOption);
      }
    }

    // Call on initial load
    setTimeout(adjustChartForMobile, 100);

    // Call on window resize
    window.addEventListener('resize', adjustChartForMobile);

    // Export functions for TPK Line Chart
    function exportTpkLineToExcel() {
      const yearData = getDataByYear(selectedYear);
      const exportData = [];
      exportData.push(['Bulan', 'TPK (%)']);
      yearData.forEach(data => {
        const month = data.normalizedMonth || normalizeMonth(data.month);
        const monthName = monthAbbr[month] || month || data.month;
        const tpk = data.tpk !== null ? data.tpk.toFixed(2) : 'Data tidak tersedia';
        exportData.push([monthName, tpk]);
      });
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(exportData);
      ws['!cols'] = [{ wch: 15 }, { wch: 15 }];
      XLSX.utils.book_append_sheet(wb, ws, `Data TPK ${selectedYear}`);
      const today = new Date().toISOString().split('T')[0];
      XLSX.writeFile(wb, `Hotel_TPK_Line_${selectedYear}_${today}.xlsx`);
    }

    function exportTpkLineToPNG() {
      const url = lineChart.getDataURL({ type: 'png', pixelRatio: 2, backgroundColor: '#fff' });
      const link = document.createElement('a');
      link.download = `Hotel_TPK_Line_${selectedYear}_${new Date().toISOString().split('T')[0]}.png`;
      link.href = url;
      link.click();
    }

    document.getElementById('downloadTpkLineExcel').addEventListener('click', exportTpkLineToExcel);
    document.getElementById('downloadTpkLinePNG').addEventListener('click', exportTpkLineToPNG);

    // Export functions for TPK Comparison Chart
    function exportTpkComparisonToExcel() {
      const recentYears = years.slice(-3);
      const allMonths = new Set();
      recentYears.forEach(year => {
        const yearData = getDataByYear(year);
        yearData.forEach(d => {
          const normalizedMonth = d.normalizedMonth || normalizeMonth(d.month);
          if (normalizedMonth) {
            allMonths.add(normalizedMonth);
          }
        });
      });
      
      const sortedMonths = [];
      monthOrder.forEach(month => {
        if (allMonths.has(month)) {
          sortedMonths.push(month);
        }
      });
      
      const labels = sortedMonths.map(month => monthAbbr[month] || month);
      const exportData = [];
      const header = ['Bulan', ...recentYears.map(y => `${y} (%)`)];
      exportData.push(header);
      
      labels.forEach((label, monthIndex) => {
        const row = [label];
        recentYears.forEach(year => {
          const yearData = getDataByYear(year);
          const month = sortedMonths[monthIndex];
          const dataPoint = yearData.find(d => {
            const normalizedMonth = d.normalizedMonth || normalizeMonth(d.month);
            return normalizedMonth === month;
          });
          const value = dataPoint && dataPoint.tpk !== null ? dataPoint.tpk.toFixed(2) : 'Data tidak tersedia';
          row.push(value);
        });
        exportData.push(row);
      });
      
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(exportData);
      ws['!cols'] = [{ wch: 15 }, ...recentYears.map(() => ({ wch: 15 }))];
      XLSX.utils.book_append_sheet(wb, ws, 'Data Perbandingan');
      const today = new Date().toISOString().split('T')[0];
      XLSX.writeFile(wb, `Hotel_TPK_Perbandingan_${today}.xlsx`);
    }

    function exportTpkComparisonToPNG() {
      const url = comparisonChart.getDataURL({ type: 'png', pixelRatio: 2, backgroundColor: '#fff' });
      const link = document.createElement('a');
      link.download = `Hotel_TPK_Perbandingan_${new Date().toISOString().split('T')[0]}.png`;
      link.href = url;
      link.click();
    }

    document.getElementById('downloadTpkComparisonExcel').addEventListener('click', exportTpkComparisonToExcel);
    document.getElementById('downloadTpkComparisonPNG').addEventListener('click', exportTpkComparisonToPNG);
  });
</script>
{% endblock %}